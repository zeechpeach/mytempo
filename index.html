<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo</title>
    <meta name="description" content="Personal energy and rhythm management">
    <meta name="theme-color" content="#FAF9F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tempo">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&family=Fraunces:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#FAF9F7;--bg-elevated:#FFF;--text-primary:#1A1A1A;--text-secondary:#6B6B6B;--text-tertiary:#9B9B9B;--border:#E8E6E3;--border-light:#F0EEEB;--accent:#2D5A45;--accent-light:#E8F0EC;--warning:#B8860B;--recurring:#6B5B7A;--danger:#C4523B;--physical:#3B7BC4;--event:#5B7A9E;--shadow-sm:0 1px 2px rgba(0,0,0,0.04);--shadow-md:0 4px 12px rgba(0,0,0,0.08);--shadow-lg:0 8px 24px rgba(0,0,0,0.08);--radius-sm:6px;--radius-md:10px;--radius-lg:14px}
        body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text-primary);min-height:100vh;line-height:1.5}
        .container{max-width:900px;margin:0 auto;padding:40px 24px}
        .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:48px;flex-wrap:wrap;gap:16px}
        .header-left h1{font-family:'Fraunces',serif;font-size:32px;font-weight:400;letter-spacing:-0.5px;margin-bottom:4px;display:flex;align-items:center;gap:12px}
        .sync-indicator{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;transition:all 0.3s}.sync-indicator.syncing{background:var(--warning);animation:pulse 1s infinite}.sync-indicator.offline{background:var(--text-tertiary)}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        .capacity-summary{font-size:14px;color:var(--text-secondary)}.capacity-summary span{color:var(--text-primary);font-weight:500}.capacity-summary .greeting{color:var(--accent)}
        .header-actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
        .user-menu{position:relative}.user-avatar{width:32px;height:32px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s;border:2px solid transparent}.user-avatar:hover{border-color:var(--accent-light)}
        .user-dropdown{position:absolute;top:100%;right:0;margin-top:8px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);box-shadow:var(--shadow-md);min-width:200px;opacity:0;visibility:hidden;transform:translateY(-8px);transition:all 0.15s;z-index:50}.user-dropdown.active{opacity:1;visibility:visible;transform:translateY(0)}
        .user-dropdown-header{padding:16px;border-bottom:1px solid var(--border-light)}.user-dropdown-header p{font-size:14px;font-weight:500}.user-dropdown-header small{font-size:12px;color:var(--text-tertiary)}
        .user-dropdown-item{padding:12px 16px;font-size:14px;cursor:pointer;transition:background 0.15s;display:block;width:100%;border:none;background:none;text-align:left;font-family:inherit;color:var(--text-primary)}.user-dropdown-item:hover{background:var(--border-light)}.user-dropdown-item.danger{color:var(--danger)}
        .btn{padding:10px 18px;border-radius:var(--radius-md);font-size:14px;font-weight:500;cursor:pointer;transition:all 0.15s;border:none;font-family:inherit}
        .btn-primary{background:var(--text-primary);color:#fff}.btn-primary:hover{background:#333;transform:translateY(-1px)}
        .btn-secondary{background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border-light)}
        .btn-ghost{background:transparent;color:var(--text-tertiary);border:1px solid transparent}.btn-ghost:hover{color:var(--danger);border-color:var(--danger)}
        .btn-danger{background:var(--bg-elevated);color:var(--danger);border:1px solid var(--danger)}.btn-danger:hover{background:#FDF5F4}
        .btn-sm{padding:6px 12px;font-size:12px}
        .btn-link{background:none;border:none;color:var(--accent);font-size:13px;cursor:pointer;padding:0}.btn-link:hover{text-decoration:underline}
        .section{margin-bottom:40px}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border-light)}
        .section-title{font-family:'Fraunces',serif;font-size:18px;font-weight:400}
        .section-meta{font-size:13px;color:var(--text-tertiary)}.section-meta span{color:var(--text-secondary)}
        .task-list{display:flex;flex-direction:column;gap:8px}
        .task-item{display:flex;align-items:flex-start;gap:14px;padding:16px 18px;background:var(--bg-elevated);border-radius:var(--radius-md);border:1px solid var(--border-light);transition:all 0.15s;cursor:pointer;position:relative}
        .task-item:hover{border-color:var(--border);box-shadow:var(--shadow-sm)}
        .task-item.completed{opacity:0.5;background:transparent}.task-item.completed .task-title-text{text-decoration:line-through}
        .task-item.needs-scoring{border-left:3px solid var(--warning)}.task-item.recurring{border-left:3px solid var(--recurring)}.task-item.event-type{border-left:3px solid var(--event)}
        .task-checkbox{width:20px;height:20px;border:2px solid var(--border);border-radius:50%;cursor:pointer;transition:all 0.15s;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center}
        .task-checkbox:hover{border-color:var(--accent);background:var(--accent-light)}
        .task-checkbox.checked{background:var(--accent);border-color:var(--accent)}.task-checkbox.checked::after{content:'\2713';color:#fff;font-size:12px;font-weight:600}
        .task-content{flex:1;min-width:0}.task-title{font-size:15px;font-weight:400;margin-bottom:6px;display:flex;align-items:center;gap:8px}.task-title-text{flex:1}
        .task-type-badge{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--event);color:#fff;text-transform:uppercase;letter-spacing:0.5px;flex-shrink:0}
        .task-meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .task-label{font-size:12px;padding:3px 10px;border-radius:100px;background:var(--border-light);color:var(--text-secondary)}
        .task-effort{font-size:12px;color:var(--text-tertiary)}.task-effort.unscored{color:var(--warning);font-style:italic}
        .task-recurring-badge{font-size:11px;color:var(--recurring)}
        .task-time-badge{font-size:11px;color:var(--event);font-weight:500}
        .task-points{font-size:13px;font-weight:500;color:var(--text-secondary);padding:4px 10px;background:var(--border-light);border-radius:var(--radius-sm);white-space:nowrap;flex-shrink:0}
        .task-impact{font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-tertiary)}.task-impact.critical{color:var(--danger)}.task-impact.high{color:var(--warning)}
        .task-actions{display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0}
        .pull-to-week{font-size:11px;color:var(--accent);background:var(--accent-light);border:none;padding:4px 8px;border-radius:4px;cursor:pointer;white-space:nowrap}.pull-to-week:hover{background:var(--accent);color:#fff}
        .empty-state{text-align:center;padding:48px 24px;color:var(--text-tertiary);font-size:14px}.empty-state p{margin-bottom:16px}
        .completed-section{margin-top:16px;padding-top:16px;border-top:1px dashed var(--border)}
        .completed-toggle{font-size:13px;color:var(--text-tertiary);cursor:pointer;display:flex;align-items:center;gap:6px;margin-bottom:12px}.completed-toggle:hover{color:var(--text-secondary)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;visibility:hidden;transition:all 0.2s}.modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:var(--bg-elevated);border-radius:var(--radius-lg);width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);transform:translateY(20px);transition:transform 0.2s}.modal-overlay.active .modal{transform:translateY(0)}
        .modal-header{padding:24px 24px 0;display:flex;justify-content:space-between;align-items:center}.modal-header h2{font-family:'Fraunces',serif;font-size:22px;font-weight:400}
        .modal-close{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;cursor:pointer;font-size:20px;color:var(--text-tertiary);border-radius:var(--radius-sm)}.modal-close:hover{background:var(--border-light);color:var(--text-primary)}
        .modal-body{padding:24px}.modal-footer{padding:16px 24px 24px;display:flex;gap:12px;justify-content:flex-end}
        .form-group{margin-bottom:20px}.form-label{display:block;font-size:13px;font-weight:500;color:var(--text-secondary);margin-bottom:8px}
        .form-input-wrapper{position:relative}.form-input{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:15px;font-family:inherit;transition:all 0.15s}.form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-light)}
        .form-hint{font-size:12px;color:var(--text-tertiary);margin-top:8px}
        .form-row{display:flex;gap:12px}.form-row .form-group{flex:1;margin-bottom:0}
        .autocomplete-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);box-shadow:var(--shadow-md);max-height:200px;overflow-y:auto;z-index:10;display:none}.autocomplete-dropdown.active{display:block}
        .autocomplete-item{padding:12px 14px;cursor:pointer;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center}.autocomplete-item:last-child{border-bottom:none}.autocomplete-item:hover{background:var(--border-light)}
        .type-toggle{display:flex;gap:8px;margin-bottom:20px}.type-chip{flex:1;padding:12px;text-align:center;border:1px solid var(--border);border-radius:var(--radius-md);font-size:13px;cursor:pointer;transition:all 0.15s}.type-chip:hover{border-color:var(--text-tertiary)}.type-chip.selected{background:var(--text-primary);color:#fff;border-color:var(--text-primary)}.type-chip small{display:block;font-size:11px;opacity:0.7;margin-top:2px}
        .chip-group{display:flex;flex-wrap:wrap;gap:8px}.chip{padding:8px 14px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:13px;cursor:pointer;transition:all 0.15s;background:var(--bg-elevated)}.chip:hover{border-color:var(--text-tertiary)}.chip.selected{background:var(--text-primary);color:#fff;border-color:var(--text-primary)}.chip-small{padding:6px 12px;font-size:12px}
        .day-chips{display:flex;gap:6px}.day-chip{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;font-weight:500;cursor:pointer;transition:all 0.15s}.day-chip:hover{border-color:var(--text-tertiary)}.day-chip.selected{background:var(--text-primary);color:#fff;border-color:var(--text-primary)}
        .labels-input-row{display:flex;gap:8px}.labels-input-row .form-input{flex:1}.existing-labels{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}.label-chip{padding:6px 12px;background:var(--border-light);border-radius:100px;font-size:12px;cursor:pointer;transition:all 0.15s}.label-chip:hover{background:var(--border)}.label-chip.selected{background:var(--text-primary);color:#fff}
        .add-physical{font-size:12px;color:var(--physical);cursor:pointer;margin-top:8px;display:inline-flex;align-items:center;gap:4px}.add-physical:hover{text-decoration:underline}
        .physical-row{margin-top:12px;padding-top:12px;border-top:1px dashed var(--border-light)}.physical-row .form-label{color:var(--physical)}
        .stats-panel{position:fixed;right:-400px;top:0;bottom:0;width:400px;background:var(--bg-elevated);box-shadow:var(--shadow-lg);z-index:90;transition:right 0.3s;overflow-y:auto}.stats-panel.active{right:0}
        .stats-header{padding:24px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center}.stats-header h2{font-family:'Fraunces',serif;font-size:20px;font-weight:400}
        .stats-close{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;cursor:pointer;font-size:20px;color:var(--text-tertiary);border-radius:var(--radius-sm)}.stats-close:hover{background:var(--border-light);color:var(--text-primary)}
        .stats-body{padding:24px}.stat-card{padding:20px;background:var(--bg);border-radius:var(--radius-md);margin-bottom:16px}.stat-card h3{font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-tertiary);margin-bottom:8px}.stat-value{font-family:'Fraunces',serif;font-size:36px;font-weight:400}.stat-value small{font-size:14px;color:var(--text-secondary);font-family:'DM Sans',sans-serif}
        .chart-bars{display:flex;align-items:flex-end;gap:6px;height:120px;padding:8px 0}.chart-bar{flex:1;background:var(--accent-light);border-radius:4px 4px 0 0;position:relative;min-height:4px;transition:all 0.2s}.chart-bar:hover{background:var(--accent)}.chart-bar-tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--text-primary);color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.15s}.chart-bar:hover .chart-bar-tooltip{opacity:1}.chart-labels{display:flex;gap:6px;margin-top:8px}.chart-label{flex:1;text-align:center;font-size:10px;color:var(--text-tertiary)}
        .no-data{text-align:center;padding:40px 20px;color:var(--text-tertiary);font-size:14px}
        .stats-actions{margin-top:24px;padding-top:24px;border-top:1px solid var(--border-light)}.stats-actions h3{font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-tertiary);margin-bottom:12px}.stats-actions-row{display:flex;gap:8px;flex-wrap:wrap}
        .recurring-list{margin-top:16px}.recurring-item{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border-radius:var(--radius-md);margin-bottom:8px}.recurring-item-info h4{font-size:14px;font-weight:500;margin-bottom:4px;display:flex;align-items:center;gap:6px}.recurring-item-info p{font-size:12px;color:var(--text-tertiary)}.recurring-item-actions{display:flex;gap:8px}
        .filter-bar{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}.filter-pill{padding:6px 14px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:100px;font-size:13px;cursor:pointer;transition:all 0.15s}.filter-pill:hover{border-color:var(--text-tertiary)}.filter-pill.active{background:var(--text-primary);color:#fff;border-color:var(--text-primary)}
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:80;opacity:0;visibility:hidden;transition:all 0.2s}.overlay.active{opacity:1;visibility:visible}
        .confirm-dialog{text-align:center;padding:8px 0}.confirm-dialog p{margin-bottom:20px;color:var(--text-secondary)}.confirm-dialog-actions{display:flex;gap:12px;justify-content:center}
        .auth-form{text-align:center}.auth-form p{margin-bottom:24px;color:var(--text-secondary)}.auth-form .form-group{text-align:left}.auth-sent{padding:20px 0}.auth-sent p{margin-bottom:8px}
        .auth-tabs{display:flex;gap:0;margin-bottom:24px;border-bottom:1px solid var(--border)}.auth-tab{flex:1;padding:12px;text-align:center;font-size:14px;font-weight:500;color:var(--text-tertiary);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s}.auth-tab:hover{color:var(--text-secondary)}.auth-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
        .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--text-primary);color:#fff;padding:12px 20px;border-radius:var(--radius-md);font-size:14px;z-index:200;opacity:0;transition:all 0.3s}.toast.active{transform:translateX(-50%) translateY(0);opacity:1}
        .file-input-hidden{position:absolute;opacity:0;pointer-events:none}
        .password-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-tertiary);cursor:pointer;padding:4px;font-size:12px}.password-toggle:hover{color:var(--text-secondary)}
        @media(max-width:640px){.container{padding:24px 16px}.header{flex-direction:column}.header-actions{width:100%}.header-actions .btn{flex:1}.stats-panel{width:100%;right:-100%}.day-chip{width:36px;height:36px}}
    </style>
</head>
<body>
    <div class="container" id="app"></div>
    <div class="toast" id="toast"></div>
    <input type="file" id="importFile" class="file-input-hidden" accept=".json">
    <script>
    // === TEMPO v3.3 ===
    const SUPABASE_URL = 'https://dfugzacpshrwzciqxdgg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmdWd6YWNwc2hyd3pjaXF4ZGdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4Nzc3MTUsImV4cCI6MjA4MDQ1MzcxNX0.Hf85iHT-EqNqsOGE8llGFzrKMLyi0ZSlwARN-vqAoyo';
    const STORAGE_KEY='tempoState',HISTORY_DAYS=90,PROMPT_AFTER_DAYS=7;
    const DAY_MAP=['sun','mon','tue','wed','thu','fri','sat'],DAY_LABELS=['S','M','T','W','T','F','S'];
    const TIME_LABELS={1:'Under 15 min',2:'15 min - 1 hr',3:'1 - 3 hr',4:'3+ hr'};
    const MENTAL_LABELS={1:'Autopilot',2:'Light',3:'Medium',4:'Heavy'};
    const PHYSICAL_LABELS={1:'Light',2:'Moderate',3:'Intense',4:'Exhausting'};
    const IMPACT_LABELS={low:'Low',medium:'Medium',high:'High',critical:'Critical'};
    const IMPACT_ORDER={critical:4,high:3,medium:2,low:1};

    const state={tasks:[],recurringTemplates:[],labels:[],completionHistory:[],lastOpenDate:null,activeFilter:null,showCompleted:{today:false,week:false,beyond:false},statsOpen:false,modalOpen:null,editingTask:null,editingTemplate:null,confirmCallback:null,confirmMessage:null,showPhysical:false,autocompleteResults:[],autocompleteVisible:false,userDropdownOpen:false,user:null,userName:null,syncStatus:'offline',firstUseDate:null,authEmail:'',authPassword:'',authSent:false,authLoading:false,authMode:'signin',showPassword:false,newPassword:'',confirmNewPassword:''};

    let supabaseClient=null;
    function initSupabase(){if(SUPABASE_URL==='YOUR_SUPABASE_URL')return false;if(typeof window.supabase==='undefined')return false;try{supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);return true;}catch(e){return false;}}

    // === UTILITIES ===
    const generateId=()=>crypto.randomUUID?crypto.randomUUID():'id-'+Date.now()+'-'+Math.random().toString(36).substr(2,9);
    const escapeHtml=s=>s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'):'';
    const getLocalDate=(d=new Date())=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const parseDate=s=>{const[y,m,d]=(s||'').split('-').map(Number);return new Date(y||2024,((m||1)-1),(d||1));};
    const addDays=(s,n)=>{const d=parseDate(s);d.setDate(d.getDate()+n);return getLocalDate(d);};
    const daysBetween=(a,b)=>Math.floor((parseDate(b)-parseDate(a))/(1000*60*60*24));
    const showToast=msg=>{const t=document.getElementById('toast');if(t){t.textContent=msg;t.classList.add('active');setTimeout(()=>t.classList.remove('active'),3000);}};
    const getPoints=task=>(task&&task.timeEffort&&task.mentalLoad)?task.timeEffort+task.mentalLoad+(task.physicalLoad||0):null;
    const getInitials=name=>name?name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2):'?';
    function formatEventTime(task){if(!task.startTime)return '';let r=task.startTime;if(task.endTime)r+=' - '+task.endTime;return r;}

    // === AUTH ===
    async function checkAuth(){if(!supabaseClient)return;try{const{data:{session}}=await supabaseClient.auth.getSession();if(session?.user){state.user=session.user;state.userName=session.user.user_metadata?.display_name||localStorage.getItem('tempo_user_name')||session.user.email?.split('@')[0]||'User';state.syncStatus='synced';render();await syncFromCloud();}}catch(e){console.error('Auth check failed:',e);}render();}
    async function signUpWithEmail(email){if(!supabaseClient||!email)return;state.authLoading=true;render();try{const{error}=await supabaseClient.auth.signInWithOtp({email,options:{emailRedirectTo:window.location.origin}});if(error)throw error;state.authSent=true;state.authEmail=email;}catch(e){showToast('Failed to send link: '+e.message);}state.authLoading=false;render();}
    async function signInWithPassword(email,password){if(!supabaseClient||!email||!password)return;state.authLoading=true;render();try{const{error}=await supabaseClient.auth.signInWithPassword({email,password});if(error)throw error;closeModal();showToast('Signed in successfully');}catch(e){if(e.message.includes('Invalid login credentials'))showToast('Invalid email or password');else if(e.message.includes('Email not confirmed'))showToast('Please check your email to confirm your account');else showToast('Sign in failed: '+e.message);}state.authLoading=false;render();}
    async function changePassword(newPassword){if(!supabaseClient||!state.user)return;state.authLoading=true;render();try{const{error}=await supabaseClient.auth.updateUser({password:newPassword});if(error)throw error;showToast('Password updated successfully');closeModal();}catch(e){showToast('Failed to update password: '+e.message);}state.authLoading=false;render();}
    async function signOut(){if(!supabaseClient)return;try{await supabaseClient.auth.signOut();state.user=null;state.userName=null;state.syncStatus='offline';state.userDropdownOpen=false;localStorage.removeItem('tempo_user_name');showToast('Signed out');}catch(e){showToast('Sign out failed');}render();}

    // === SYNC ===
    async function syncToCloud(){if(!supabaseClient||!state.user)return;state.syncStatus='syncing';render();try{const dataToSync={tasks:state.tasks,recurringTemplates:state.recurringTemplates,labels:state.labels,completionHistory:state.completionHistory,lastOpenDate:state.lastOpenDate,firstUseDate:state.firstUseDate};const{error}=await supabaseClient.from('user_data').upsert({user_id:state.user.id,data:dataToSync},{onConflict:'user_id'});if(error)throw error;state.syncStatus='synced';}catch(e){state.syncStatus='offline';showToast('Sync failed - changes saved locally');}render();}
    async function syncFromCloud(){if(!supabaseClient||!state.user)return;try{const{data,error}=await supabaseClient.from('user_data').select('data').eq('user_id',state.user.id).single();if(error&&error.code!=='PGRST116')throw error;if(data?.data){const cloud=data.data;if(cloud.tasks?.length||cloud.recurringTemplates?.length){state.tasks=cloud.tasks||[];state.recurringTemplates=cloud.recurringTemplates||[];state.labels=cloud.labels||[];state.completionHistory=cloud.completionHistory||[];state.lastOpenDate=cloud.lastOpenDate;state.firstUseDate=cloud.firstUseDate;state.tasks.forEach(t=>{if(!t.type)t.type='task';});state.recurringTemplates.forEach(t=>{if(!t.type)t.type='task';});saveLocal();}else if(state.tasks.length||state.recurringTemplates.length){await syncToCloud();}}else if(state.tasks.length||state.recurringTemplates.length){await syncToCloud();}}catch(e){console.error('Sync from cloud failed:',e);}}
    let syncTimeout=null;function queueSync(){if(syncTimeout)clearTimeout(syncTimeout);syncTimeout=setTimeout(()=>syncToCloud(),2000);}

    // === LOCAL STORAGE ===
    function loadLocal(){try{const saved=localStorage.getItem(STORAGE_KEY);if(saved){const p=JSON.parse(saved);state.tasks=Array.isArray(p.tasks)?p.tasks:[];state.recurringTemplates=Array.isArray(p.recurringTemplates)?p.recurringTemplates:[];state.labels=Array.isArray(p.labels)?p.labels:[];state.completionHistory=Array.isArray(p.completionHistory)?p.completionHistory:[];state.lastOpenDate=p.lastOpenDate||null;state.firstUseDate=p.firstUseDate||getLocalDate();state.tasks.forEach(t=>{if(!t.type)t.type='task';if(t.physicalLoad===undefined)t.physicalLoad=0;});state.recurringTemplates.forEach(t=>{if(!t.type)t.type='task';if(t.physicalLoad===undefined)t.physicalLoad=0;});}else{state.firstUseDate=getLocalDate();}}catch(e){state.firstUseDate=getLocalDate();}}
    function saveLocal(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify({tasks:state.tasks,recurringTemplates:state.recurringTemplates,labels:state.labels,completionHistory:state.completionHistory,lastOpenDate:state.lastOpenDate,firstUseDate:state.firstUseDate}));}catch(e){showToast('Save failed');}}
    function saveState(){saveLocal();if(state.user)queueSync();}
    function shouldPromptForAccount(){if(state.user||!supabaseClient||!state.firstUseDate)return false;return daysBetween(state.firstUseDate,getLocalDate())>=PROMPT_AFTER_DAYS;}

    // === CORE LOGIC ===
    function pruneHistory(){const cutoff=addDays(getLocalDate(),-HISTORY_DAYS);state.completionHistory=state.completionHistory.filter(h=>h&&h.date>=cutoff);}
    function clearHistory(){state.completionHistory=[];state.tasks.forEach(t=>{t.historyEntryId=null;});saveState();render();showToast('History cleared');}
    function processMissedDays(){const today=getLocalDate();if(!state.lastOpenDate||state.lastOpenDate>=today){generateRecurringFor(today);return;}let current=addDays(state.lastOpenDate,1),iterations=0;while(current<=today&&iterations<365){generateRecurringFor(current);if(current<today)autoSkipFor(current);current=addDays(current,1);iterations++;}}
    function generateRecurringFor(dateStr){const dow=DAY_MAP[parseDate(dateStr).getDay()];state.recurringTemplates.forEach(t=>{if(!t||!Array.isArray(t.days)||!t.days.includes(dow))return;if(state.tasks.some(x=>x.recurringTemplateId===t.id&&x.scheduledDate===dateStr))return;state.tasks.push({id:generateId(),title:t.title||'Untitled',label:t.label||'',type:t.type||'task',timeframe:dateStr===getLocalDate()?'today':'week',timeEffort:t.timeEffort,mentalLoad:t.mentalLoad,physicalLoad:t.physicalLoad||0,impact:t.type==='event'?null:t.impact,completed:false,startTime:t.startTime||'',endTime:t.endTime||'',recurringTemplateId:t.id,scheduledDate:dateStr,createdAt:new Date().toISOString(),historyEntryId:null});});}
    function autoSkipFor(dateStr){state.tasks=state.tasks.filter(task=>{if(task.recurringTemplateId&&!task.completed&&task.scheduledDate===dateStr){state.completionHistory.push({id:generateId(),date:dateStr,points:0,taskTitle:task.title,skipped:true});return false;}return true;});}
    function getAutocompleteSuggestions(query){if(!query||query.length<2)return[];const q=query.toLowerCase(),seen=new Map();[...state.tasks].filter(t=>t.completed&&t.title&&t.title.toLowerCase().includes(q)).sort((a,b)=>(b.completedAt||b.createdAt||'').localeCompare(a.completedAt||a.createdAt||'')).forEach(t=>{const key=t.title.toLowerCase();if(!seen.has(key))seen.set(key,{title:t.title,label:t.label,type:t.type||'task',timeEffort:t.timeEffort,mentalLoad:t.mentalLoad,physicalLoad:t.physicalLoad||0,impact:t.impact,startTime:t.startTime||'',endTime:t.endTime||''});});state.recurringTemplates.filter(t=>t.title&&t.title.toLowerCase().includes(q)).forEach(t=>{const key=t.title.toLowerCase();if(!seen.has(key))seen.set(key,{title:t.title,label:t.label,type:t.type||'task',timeEffort:t.timeEffort,mentalLoad:t.mentalLoad,physicalLoad:t.physicalLoad||0,impact:t.impact,startTime:t.startTime||'',endTime:t.endTime||''});});return Array.from(seen.values()).slice(0,5);}
    function getTodayStats(){const today=getLocalDate();let queued=0,done=0,recurringCount=0;state.tasks.filter(t=>t.timeframe==='today').forEach(task=>{const pts=getPoints(task)||0;if(task.completed)done+=pts;else{queued+=pts;if(task.recurringTemplateId)recurringCount++;}});const todayTaskIds=new Set(state.tasks.filter(t=>t.timeframe==='today'&&t.completed).map(t=>t.historyEntryId).filter(Boolean));state.completionHistory.filter(h=>h.date===today&&!h.skipped&&!todayTaskIds.has(h.id)).forEach(h=>done+=(h.points||0));return{queued,done,recurringCount};}
    function getAverages(){const hist={};state.completionHistory.filter(h=>!h.skipped).forEach(h=>{hist[h.date]=(hist[h.date]||0)+(h.points||0);});const dates=Object.keys(hist).sort();const avg=arr=>arr.length?Math.round(arr.reduce((s,d)=>s+hist[d],0)/arr.length):null;return{avg7:avg(dates.slice(-7)),avg30:avg(dates.slice(-30)),hist};}
    function sortTasks(tasks){return[...tasks].sort((a,b)=>{if(a.completed!==b.completed)return a.completed?1:-1;if((a.type==='event')!==(b.type==='event'))return a.type==='event'?-1:1;if(a.type==='event'&&b.type==='event'&&a.startTime&&b.startTime)return a.startTime.localeCompare(b.startTime);const aS=getPoints(a)!==null,bS=getPoints(b)!==null;if(aS!==bS)return aS?-1:1;if(a.type!=='event'&&b.type!=='event'){const aI=IMPACT_ORDER[a.impact]||0,bI=IMPACT_ORDER[b.impact]||0;if(aI!==bI)return bI-aI;}return(getPoints(a)||0)-(getPoints(b)||0);});}
    function formatEffort(task){if(!task||!task.timeEffort||!task.mentalLoad)return '';let parts=[TIME_LABELS[task.timeEffort],MENTAL_LABELS[task.mentalLoad]];if(task.physicalLoad)parts.push(PHYSICAL_LABELS[task.physicalLoad]+' physical');return parts.join(' / ');}
    function formatDays(days){if(!Array.isArray(days))return '';if(days.length===7)return 'Daily';if(days.length===5&&!days.includes('sat')&&!days.includes('sun'))return 'Weekdays';if(days.length===2&&days.includes('sat')&&days.includes('sun'))return 'Weekends';const m={mon:'Mon',tue:'Tue',wed:'Wed',thu:'Thu',fri:'Fri',sat:'Sat',sun:'Sun'};return days.map(d=>m[d]||d).join(', ');}

    // === EXPORT/IMPORT ===
    function exportData(){const blob=new Blob([JSON.stringify({version:3,exportedAt:new Date().toISOString(),tasks:state.tasks,recurringTemplates:state.recurringTemplates,labels:state.labels,completionHistory:state.completionHistory},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`tempo-backup-${getLocalDate()}.json`;a.click();showToast('Data exported');}
    function importData(){document.getElementById('importFile').click();}
    function handleImport(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{try{const data=JSON.parse(ev.target.result);if(!data.tasks&&!data.recurringTemplates)throw new Error('Invalid');showConfirm('Replace all data with imported file?',()=>{state.tasks=Array.isArray(data.tasks)?data.tasks:[];state.recurringTemplates=Array.isArray(data.recurringTemplates)?data.recurringTemplates:[];state.labels=Array.isArray(data.labels)?data.labels:[];state.completionHistory=Array.isArray(data.completionHistory)?data.completionHistory:[];state.lastOpenDate=getLocalDate();state.tasks.forEach(t=>{if(!t.type)t.type='task';});state.recurringTemplates.forEach(t=>{if(!t.type)t.type='task';});saveState();render();showToast('Imported successfully');});}catch(err){showToast('Import failed - invalid file');}};reader.readAsText(file);e.target.value='';}

    // === RENDER ===
    function render(){const app=document.getElementById('app');if(!app)return;const stats=getTodayStats(),{avg7}=getAverages();const filtered=state.activeFilter?state.tasks.filter(t=>t.label===state.activeFilter):state.tasks;const todayTasks=sortTasks(filtered.filter(t=>t.timeframe==='today'));const weekTasks=sortTasks(filtered.filter(t=>t.timeframe==='week'));const beyondTasks=sortTasks(filtered.filter(t=>t.timeframe==='beyond'));const activeToday=todayTasks.filter(t=>!t.completed),completedToday=todayTasks.filter(t=>t.completed);const activeWeek=weekTasks.filter(t=>!t.completed),completedWeek=weekTasks.filter(t=>t.completed);const activeBeyond=beyondTasks.filter(t=>!t.completed),completedBeyond=beyondTasks.filter(t=>t.completed);let greeting='';if(state.user&&state.userName)greeting=`<span class="greeting">Hi, ${escapeHtml(state.userName.split(' ')[0])}</span> / `;let summary=`${greeting}<span>${stats.queued}</span> pts queued / <span>${stats.done}</span> pts done`;if(avg7)summary+=` / avg <span>${avg7}</span>`;const syncClass=state.user?(state.syncStatus==='syncing'?'syncing':'synced'):'offline';
    app.innerHTML=`<header class="header"><div class="header-left"><h1>Tempo ${state.user?`<span class="sync-indicator ${syncClass}" title="${state.syncStatus}"></span>`:''}</h1><div class="capacity-summary">${summary}</div></div><div class="header-actions">${state.user?`<div class="user-menu"><div class="user-avatar" onclick="toggleUserDropdown()">${getInitials(state.userName)}</div><div class="user-dropdown ${state.userDropdownOpen?'active':''}"><div class="user-dropdown-header"><p>${escapeHtml(state.userName)}</p><small>${escapeHtml(state.user.email)}</small></div><button class="user-dropdown-item" onclick="openStats()">Stats & Data</button><button class="user-dropdown-item" onclick="openChangePassword()">Change Password</button><button class="user-dropdown-item danger" onclick="signOut()">Sign Out</button></div></div>`:(supabaseClient?`<button class="btn-link" onclick="openAuth()">Sign in</button>`:'')}<button class="btn btn-secondary" onclick="openStats()">Stats</button><button class="btn btn-secondary" onclick="openRecurring()">Recurring</button><button class="btn btn-primary" onclick="openAdd()">+ Add</button></div></header>${shouldPromptForAccount()?`<div style="background:var(--accent-light);padding:16px;border-radius:var(--radius-md);margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px"><span style="font-size:14px;color:var(--accent)">Access your tasks from any device</span><button class="btn btn-primary btn-sm" onclick="openAuth()">Create free account</button></div>`:''}`+
    `${state.labels.length?`<div class="filter-bar"><div class="filter-pill ${!state.activeFilter?'active':''}" onclick="setFilter(null)">All</div>${state.labels.map(l=>`<div class="filter-pill ${state.activeFilter===l?'active':''}" onclick="setFilter('${escapeHtml(l)}')">${escapeHtml(l)}</div>`).join('')}</div>`:''}`+
    `<section class="section"><div class="section-header"><h2 class="section-title">Today</h2><div class="section-meta">${stats.recurringCount?`<span>${stats.recurringCount}</span> recurring / `:''}<span>${stats.queued}</span> pts</div></div><div class="task-list">${activeToday.length?activeToday.map(t=>renderTask(t,'today')).join(''):'<div class="empty-state"><p>Nothing planned</p><button class="btn btn-secondary" onclick="openAdd()">Add task</button></div>'}</div>${completedToday.length?`<div class="completed-section"><div class="completed-toggle" onclick="toggleCompleted('today')">${state.showCompleted.today?'\u25BC':'\u25B6'} ${completedToday.length} completed</div>${state.showCompleted.today?`<div class="task-list">${completedToday.map(t=>renderTask(t,'today')).join('')}</div>`:''}</div>`:''}</section>`+
    `<section class="section"><div class="section-header"><h2 class="section-title">This Week</h2><div class="section-meta"><span>${activeWeek.reduce((s,t)=>s+(getPoints(t)||0),0)}</span> pts</div></div><div class="task-list">${activeWeek.length?activeWeek.map(t=>renderTask(t,'week')).join(''):'<div class="empty-state"><p>Nothing planned</p></div>'}</div>${completedWeek.length?`<div class="completed-section"><div class="completed-toggle" onclick="toggleCompleted('week')">${state.showCompleted.week?'\u25BC':'\u25B6'} ${completedWeek.length} completed</div>${state.showCompleted.week?`<div class="task-list">${completedWeek.map(t=>renderTask(t,'week')).join('')}</div>`:''}</div>`:''}</section>`+
    `<section class="section"><div class="section-header"><h2 class="section-title">Beyond</h2><div class="section-meta"><span>${activeBeyond.length}</span> tasks</div></div><div class="task-list">${activeBeyond.length?activeBeyond.map(t=>renderTask(t,'beyond')).join(''):'<div class="empty-state"><p>No backlog</p></div>'}</div>${completedBeyond.length?`<div class="completed-section"><div class="completed-toggle" onclick="toggleCompleted('beyond')">${state.showCompleted.beyond?'\u25BC':'\u25B6'} ${completedBeyond.length} completed</div>${state.showCompleted.beyond?`<div class="task-list">${completedBeyond.map(t=>renderTask(t,'beyond')).join('')}</div>`:''}</div>`:''}</section>`+
    `<div class="overlay ${state.statsOpen?'active':''}" onclick="closeStats()"></div><div class="stats-panel ${state.statsOpen?'active':''}">${renderStats()}</div><div class="modal-overlay ${state.modalOpen?'active':''}" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()">${renderModal()}</div></div>`;}

    function renderTask(task,section){const pts=getPoints(task),unscored=pts===null,recurring=!!task.recurringTemplateId,isEvent=task.type==='event';const eventTime=formatEventTime(task);let classes=['task-item'];if(task.completed)classes.push('completed');if(unscored)classes.push('needs-scoring');if(recurring)classes.push('recurring');if(isEvent)classes.push('event-type');const showPullToWeek=section==='beyond'&&!task.completed;return`<div class="${classes.join(' ')}" onclick="editTask('${task.id}')"><div class="task-checkbox ${task.completed?'checked':''}" onclick="event.stopPropagation();toggleTask('${task.id}')"></div><div class="task-content"><div class="task-title">${isEvent?'<span class="task-type-badge">Event</span>':''}<span class="task-title-text">${escapeHtml(task.title)}</span></div><div class="task-meta">${eventTime?`<span class="task-time-badge">${escapeHtml(eventTime)}</span>`:''}${task.label?`<span class="task-label">${escapeHtml(task.label)}</span>`:''}${recurring?`<span class="task-recurring-badge">\u21BB Recurring</span>`:''}${unscored?`<span class="task-effort unscored">Needs scoring</span>`:`<span class="task-effort">${formatEffort(task)}</span>`}${!isEvent&&task.impact?`<span class="task-impact ${task.impact}">${IMPACT_LABELS[task.impact]}</span>`:''}</div></div>${pts!==null||showPullToWeek?`<div class="task-actions">${pts!==null?`<div class="task-points">${pts} pts</div>`:''}${showPullToWeek?`<button class="pull-to-week" onclick="event.stopPropagation();pullToWeek('${task.id}')">\u2192 Week</button>`:''}</div>`:''}</div>`;}

    // === MODAL RENDERERS ===
    function renderModal(){if(state.modalOpen==='add'||state.modalOpen==='edit')return renderTaskModal();if(state.modalOpen==='score')return renderScoreModal();if(state.modalOpen==='recurring')return renderRecurringList();if(state.modalOpen==='addRecurring'||state.modalOpen==='editRecurring')return renderRecurringForm();if(state.modalOpen==='confirm')return renderConfirm();if(state.modalOpen==='auth')return renderAuthModal();if(state.modalOpen==='getName')return renderGetNameModal();if(state.modalOpen==='changePassword')return renderChangePasswordModal();return '';}

    function renderGetNameModal(){return`<div class="modal-header"><h2>Welcome to Tempo</h2></div><div class="modal-body"><div class="form-group"><label class="form-label">What should we call you?</label><input type="text" class="form-input" id="userName" placeholder="Your first name" onkeydown="if(event.key==='Enter')document.getElementById('userPassword').focus()"></div><div class="form-group"><label class="form-label">Create a password</label><div class="form-input-wrapper"><input type="${state.showPassword?'text':'password'}" class="form-input" id="userPassword" placeholder="At least 6 characters" style="padding-right:60px" onkeydown="if(event.key==='Enter')saveName()"><button type="button" class="password-toggle" onclick="togglePasswordVisibility()">${state.showPassword?'Hide':'Show'}</button></div><div class="form-hint">You'll use this password to sign in on other devices</div></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveName()">Continue</button></div>`;}

    function renderChangePasswordModal(){return`<div class="modal-header"><h2>Change Password</h2><button class="modal-close" onclick="closeModal()">\u00D7</button></div><div class="modal-body"><div class="form-group"><label class="form-label">New Password</label><div class="form-input-wrapper"><input type="${state.showPassword?'text':'password'}" class="form-input" id="newPassword" placeholder="At least 6 characters" style="padding-right:60px" value="${escapeHtml(state.newPassword)}" oninput="state.newPassword=this.value"><button type="button" class="password-toggle" onclick="togglePasswordVisibility()">${state.showPassword?'Hide':'Show'}</button></div></div><div class="form-group"><label class="form-label">Confirm New Password</label><input type="${state.showPassword?'text':'password'}" class="form-input" id="confirmNewPassword" placeholder="Re-enter password" value="${escapeHtml(state.confirmNewPassword)}" oninput="state.confirmNewPassword=this.value" onkeydown="if(event.key==='Enter')submitChangePassword()"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="submitChangePassword()" ${state.authLoading?'disabled':''}>${state.authLoading?'Updating...':'Update Password'}</button></div>`;}

    function renderAuthModal(){if(state.authSent){return`<div class="modal-header"><h2>Check your email</h2><button class="modal-close" onclick="closeModal()">\u00D7</button></div><div class="modal-body"><div class="auth-sent"><p>We sent a sign-up link to:</p><p><strong>${escapeHtml(state.authEmail)}</strong></p><p style="margin-top:16px;color:var(--text-tertiary);font-size:13px">Click the link in your email to create your account. You can close this window.</p></div></div>`;}const isSignIn=state.authMode==='signin';return`<div class="modal-header"><h2>${isSignIn?'Sign In':'Create Account'}</h2><button class="modal-close" onclick="closeModal()">\u00D7</button></div><div class="modal-body"><div class="auth-tabs"><div class="auth-tab ${isSignIn?'active':''}" onclick="setAuthMode('signin')">Sign In</div><div class="auth-tab ${!isSignIn?'active':''}" onclick="setAuthMode('signup')">Sign Up</div></div><div class="auth-form">${isSignIn?`<p>Welcome back! Sign in with your email and password.</p><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="authEmail" placeholder="you@example.com" value="${escapeHtml(state.authEmail)}" oninput="state.authEmail=this.value"></div><div class="form-group"><label class="form-label">Password</label><div class="form-input-wrapper"><input type="${state.showPassword?'text':'password'}" class="form-input" id="authPassword" placeholder="Your password" style="padding-right:60px" value="${escapeHtml(state.authPassword)}" oninput="state.authPassword=this.value" onkeydown="if(event.key==='Enter')submitAuth()"><button type="button" class="password-toggle" onclick="togglePasswordVisibility()">${state.showPassword?'Hide':'Show'}</button></div></div>`:`<p>Create an account to sync your tasks across devices. We'll send you a magic link.</p><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="authEmail" placeholder="you@example.com" value="${escapeHtml(state.authEmail)}" oninput="state.authEmail=this.value" onkeydown="if(event.key==='Enter')submitAuth()"></div>`}</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="submitAuth()" ${state.authLoading?'disabled':''}>${state.authLoading?(isSignIn?'Signing in...':'Sending...'):(isSignIn?'Sign In':'Send Link')}</button></div>`;}

    function renderTaskModal(){const t=state.editingTask||{title:'',label:'',type:'task',timeframe:'today',timeEffort:null,mentalLoad:null,physicalLoad:0,impact:null,startTime:'',endTime:''};const isEdit=state.modalOpen==='edit',isEvent=t.type==='event';const showPhys=state.showPhysical||(t.physicalLoad&&t.physicalLoad>0);return`<div class="modal-header"><h2>${isEdit?'Edit':'Add'} ${isEvent?'Event':'Task'}</h2><button class="modal-close" onclick="closeModal()">\u00D7</button></div><div class="modal-body"><div class="type-toggle"><div class="type-chip ${t.type==='task'?'selected':''}" onclick="selType('task')">Task<small>Has impact priority</small></div><div class="type-chip ${t.type==='event'?'selected':''}" onclick="selType('event')">Event<small>Fixed commitment</small></div></div><div class="form-group"><label class="form-label">${isEvent?'Event':'Task'}</label><div class="form-input-wrapper"><input type="text" class="form-input" id="taskTitle" value="${escapeHtml(t.title)}" placeholder="${isEvent?"What's happening?":'What needs to be done?'}" oninput="handleTitleInput(this.value)" onfocus="handleTitleFocus()" onblur="setTimeout(hideAutocomplete,150)"><div class="autocomplete-dropdown ${state.autocompleteVisible&&state.autocompleteResults.length?'active':''}" id="autocompleteDropdown">${state.autocompleteResults.map((r,i)=>`<div class="autocomplete-item" onmousedown="selectAutocomplete(${i})"><span>${escapeHtml(r.title)}</span><span style="font-size:12px;color:var(--text-tertiary)">${getPoints(r)||'?'} pts</span></div>`).join('')}</div></div></div>${isEvent?`<div class="form-group"><label class="form-label">Time (optional)</label><div class="form-row"><div class="form-group"><input type="text" class="form-input" id="startTime" value="${escapeHtml(t.startTime||'')}" placeholder="Start (e.g. 9:00am)" oninput="updateStartTime(this.value)"></div><div class="form-group"><input type="text" class="form-input" id="endTime" value="${escapeHtml(t.endTime||'')}" placeholder="End (e.g. 10:30am)" oninput="updateEndTime(this.value)"></div></div></div>`:''}<div class="form-group"><label class="form-label">Timeframe</label><div class="chip-group">${['today','week','beyond'].map(tf=>`<div class="chip ${t.timeframe===tf?'selected':''}" onclick="selTimeframe('${tf}')">${tf==='today'?'Today':tf==='week'?'This Week':'Beyond'}</div>`).join('')}</div></div><div class="form-group"><label class="form-label">Label</label><div class="labels-input-row"><input type="text" class="form-input" id="newLabel" placeholder="New label..."><button class="btn btn-secondary" onclick="addLabel()">Add</button></div>${state.labels.length?`<div class="existing-labels">${state.labels.map(l=>`<div class="label-chip ${t.label===l?'selected':''}" onclick="selLabel('${escapeHtml(l)}')">${escapeHtml(l)}</div>`).join('')}</div>`:''}</div><div class="form-group"><label class="form-label">Time</label><div class="chip-group">${[1,2,3,4].map(v=>`<div class="chip chip-small ${t.timeEffort===v?'selected':''}" onclick="selTime(${v})">${TIME_LABELS[v]}</div>`).join('')}</div></div><div class="form-group"><label class="form-label">Mental Load</label><div class="chip-group">${[1,2,3,4].map(v=>`<div class="chip chip-small ${t.mentalLoad===v?'selected':''}" onclick="selMental(${v})">${MENTAL_LABELS[v]}</div>`).join('')}</div>${!showPhys?`<div class="add-physical" onclick="togglePhysicalUI()">+ Add physical</div>`:''}${showPhys?`<div class="physical-row"><label class="form-label">Physical Load</label><div class="chip-group">${[0,1,2,3,4].map(v=>`<div class="chip chip-small ${t.physicalLoad===v?'selected':''}" onclick="selPhysical(${v})">${v===0?'None':PHYSICAL_LABELS[v]}</div>`).join('')}</div></div>`:''}</div>${!isEvent?`<div class="form-group"><label class="form-label">Impact</label><div class="chip-group">${['low','medium','high','critical'].map(v=>`<div class="chip chip-small ${t.impact===v?'selected':''}" onclick="selImpact('${v}')">${IMPACT_LABELS[v]}</div>`).join('')}</div></div>`:''}</div><div class="modal-footer">${isEdit?`<button class="btn btn-danger" onclick="confirmDelete()" style="margin-right:auto">Delete</button>`:''}${isEdit&&!t.recurringTemplateId&&t.timeEffort&&t.mentalLoad?`<button class="btn btn-secondary" onclick="makeRecurring()">Make Recurring</button>`:''}<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveTask()">${isEdit?'Save':'Add'}</button></div>`;}

    function renderScoreModal(){const t=state.editingTask;if(!t)return '';const isEvent=t.type==='event',showPhys=state.showPhysical||(t.physicalLoad&&t.physicalLoad>0);return`<div class="modal-header"><h2>Score ${isEvent?'Event':'Task'}</h2><button class="modal-close" onclick="closeModal()">\u00D7</button></div><div class="modal-body"><p style="margin-bottom:20px;color:var(--text-secondary)">How much effort was "${escapeHtml(t.title)}"?</p><div class="form-group"><label class="form-label">Time</label><div class="chip-group">${[1,2,3,4].map(v=>`<div class="chip chip-small ${t.timeEffort===v?'selected':''}" onclick="selTime(${v})">${TIME_LABELS[v]}</div>`).join('')}</div></div><div class="form-group"><label class="form-label">Mental Load</label><div class="chip-group">${[1,2,3,4].map(v=>`<div class="chip chip-small ${t.mentalLoad===v?'selected':''}" onclick="selMental(${v})">${MENTAL_LABELS[v]}</div>`).join('')}</div>${!showPhys?`<div class="add-physical" onclick="togglePhysicalUI()">+ Add physical</div>`:''}${showPhys?`<div class="physical-row"><label class="form-label">Physical Load</label><div class="chip-group">${[0,1,2,3,4].map(v=>`<div class="chip chip-small ${t.physicalLoad===v?'selected':''}" onclick="selPhysical(${v})">${v===0?'None':PHYSICAL_LABELS[v]}</div>`).join('')}</div></div>`:''}</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="completeWithScore()">Complete</button></div>`;}

    // === MORE MODAL RENDERERS ===
    function renderRecurringList(){return`<div class="modal-header"><h2>Recurring</h2><button class="modal-close" onclick="closeModal()">\u00D7</button></div><div class="modal-body">${state.recurringTemplates.length?`<div class="recurring-list">${state.recurringTemplates.map(t=>`<div class="recurring-item"><div class="recurring-item-info"><h4>${t.type==='event'?'<span class="task-type-badge" style="font-size:9px;margin-right:6px">Event</span>':''}${escapeHtml(t.title)}${t.startTime?` <span style="font-size:11px;color:var(--event)">${escapeHtml(formatEventTime(t))}</span>`:''}</h4><p>${formatDays(t.days)} / ${getPoints(t)} pts</p></div><div class="recurring-item-actions"><button class="btn btn-secondary btn-sm" onclick="editRecurring('${t.id}')">Edit</button><button class="btn btn-danger btn-sm" onclick="confirmDeleteRecurring('${t.id}')">Delete</button></div></div>`).join('')}</div>`:'<div class="no-data"><p>No recurring items</p></div>'}</div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Close</button><button class="btn btn-primary" onclick="openAddRecurring()">+ Add</button></div>`;}

    function renderRecurringForm(){const t=state.editingTemplate||{title:'',label:'',type:'task',days:[],timeEffort:null,mentalLoad:null,physicalLoad:0,impact:null,startTime:'',endTime:''};const isEdit=state.modalOpen==='editRecurring',isEvent=t.type==='event';const showPhys=state.showPhysical||(t.physicalLoad&&t.physicalLoad>0);return`<div class="modal-header"><h2>${isEdit?'Edit':'Add'} Recurring</h2><button class="modal-close" onclick="backToList()">\u00D7</button></div><div class="modal-body"><div class="type-toggle"><div class="type-chip ${t.type==='task'?'selected':''}" onclick="selRecType('task')">Task</div><div class="type-chip ${t.type==='event'?'selected':''}" onclick="selRecType('event')">Event</div></div><div class="form-group"><label class="form-label">${isEvent?'Event':'Task'}</label><input type="text" class="form-input" id="recurringTitle" value="${escapeHtml(t.title)}" placeholder="What repeats?" oninput="updateRecTitle(this.value)"></div>${isEvent?`<div class="form-group"><label class="form-label">Time (optional)</label><div class="form-row"><div class="form-group"><input type="text" class="form-input" id="recStartTime" value="${escapeHtml(t.startTime||'')}" placeholder="Start (e.g. 9:00am)" oninput="updateRecStartTime(this.value)"></div><div class="form-group"><input type="text" class="form-input" id="recEndTime" value="${escapeHtml(t.endTime||'')}" placeholder="End (e.g. 10:30am)" oninput="updateRecEndTime(this.value)"></div></div></div>`:''}<div class="form-group"><label class="form-label">Repeats On</label><div class="day-chips">${DAY_MAP.map((d,i)=>`<div class="day-chip ${t.days.includes(d)?'selected':''}" onclick="toggleDay('${d}')">${DAY_LABELS[i]}</div>`).join('')}</div></div><div class="form-group"><label class="form-label">Label</label><div class="labels-input-row"><input type="text" class="form-input" id="newRecLabel" placeholder="New label..."><button class="btn btn-secondary" onclick="addRecLabel()">Add</button></div>${state.labels.length?`<div class="existing-labels">${state.labels.map(l=>`<div class="label-chip ${t.label===l?'selected':''}" onclick="selRecLabel('${escapeHtml(l)}')">${escapeHtml(l)}</div>`).join('')}</div>`:''}</div><div class="form-group"><label class="form-label">Time</label><div class="chip-group">${[1,2,3,4].map(v=>`<div class="chip chip-small ${t.timeEffort===v?'selected':''}" onclick="selRecTime(${v})">${TIME_LABELS[v]}</div>`).join('')}</div></div><div class="form-group"><label class="form-label">Mental Load</label><div class="chip-group">${[1,2,3,4].map(v=>`<div class="chip chip-small ${t.mentalLoad===v?'selected':''}" onclick="selRecMental(${v})">${MENTAL_LABELS[v]}</div>`).join('')}</div>${!showPhys?`<div class="add-physical" onclick="togglePhysicalUI()">+ Add physical</div>`:''}${showPhys?`<div class="physical-row"><label class="form-label">Physical Load</label><div class="chip-group">${[0,1,2,3,4].map(v=>`<div class="chip chip-small ${t.physicalLoad===v?'selected':''}" onclick="selRecPhysical(${v})">${v===0?'None':PHYSICAL_LABELS[v]}</div>`).join('')}</div></div>`:''}</div>${!isEvent?`<div class="form-group"><label class="form-label">Impact</label><div class="chip-group">${['low','medium','high','critical'].map(v=>`<div class="chip chip-small ${t.impact===v?'selected':''}" onclick="selRecImpact('${v}')">${IMPACT_LABELS[v]}</div>`).join('')}</div></div>`:''}</div><div class="modal-footer"><button class="btn btn-secondary" onclick="backToList()">Back</button><button class="btn btn-primary" onclick="saveRecurring()">${isEdit?'Save':'Add'}</button></div>`;}

    function renderConfirm(){return`<div class="modal-header"><h2>Confirm</h2></div><div class="modal-body"><div class="confirm-dialog"><p>${state.confirmMessage||'Are you sure?'}</p><div class="confirm-dialog-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-danger" onclick="execConfirm()">Confirm</button></div></div></div>`;}

    function renderStats(){const{avg7,avg30,hist}=getAverages();const dates=Object.keys(hist).sort().slice(-14);const max=Math.max(...dates.map(d=>hist[d]),1);return`<div class="stats-header"><h2>Stats</h2><button class="stats-close" onclick="closeStats()">\u00D7</button></div><div class="stats-body"><div class="stat-card"><h3>7-Day Average</h3><div class="stat-value">${avg7!==null?avg7:'\u2014'} <small>pts/day</small></div></div><div class="stat-card"><h3>30-Day Average</h3><div class="stat-value">${avg30!==null?avg30:'\u2014'} <small>pts/day</small></div></div><div style="margin-top:24px"><h3 style="font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-tertiary);margin-bottom:12px">Last 14 Days</h3>${dates.length?`<div class="chart-bars">${dates.map(d=>`<div class="chart-bar" style="height:${(hist[d]/max)*100}%"><div class="chart-bar-tooltip">${hist[d]} pts</div></div>`).join('')}</div><div class="chart-labels">${dates.map(d=>`<div class="chart-label">${parseDate(d).getDate()}</div>`).join('')}</div>`:'<div class="no-data">Complete tasks to see history</div>'}</div><div class="stats-actions"><h3>Data</h3><div class="stats-actions-row"><button class="btn btn-secondary btn-sm" onclick="exportData()">Export</button><button class="btn btn-secondary btn-sm" onclick="importData()">Import</button><button class="btn btn-ghost btn-sm" onclick="confirmClearHistory()">Clear History</button></div></div>${!state.user&&supabaseClient?`<div class="stats-actions"><h3>Account</h3><p style="font-size:13px;color:var(--text-tertiary);margin-bottom:12px">Sign in to sync across devices</p><button class="btn btn-primary btn-sm" onclick="openAuth()">Sign in</button></div>`:''}</div>`;}

    function renderModalOnly(){const modal=document.querySelector('.modal');if(modal&&state.modalOpen){const scrollTop=modal.scrollTop;modal.innerHTML=renderModal();modal.scrollTop=scrollTop;}}

    // === EVENT HANDLERS ===
    function handleTitleInput(val){if(state.editingTask)state.editingTask.title=val;state.autocompleteResults=getAutocompleteSuggestions(val);state.autocompleteVisible=true;renderAutocomplete();}
    function handleTitleFocus(){if(state.editingTask&&state.editingTask.title){state.autocompleteResults=getAutocompleteSuggestions(state.editingTask.title);state.autocompleteVisible=true;renderAutocomplete();}}
    function renderAutocomplete(){const dropdown=document.getElementById('autocompleteDropdown');if(!dropdown)return;if(state.autocompleteVisible&&state.autocompleteResults.length){dropdown.classList.add('active');dropdown.innerHTML=state.autocompleteResults.map((r,i)=>`<div class="autocomplete-item" onmousedown="selectAutocomplete(${i})"><span>${escapeHtml(r.title)}</span><span style="font-size:12px;color:var(--text-tertiary)">${getPoints(r)||'?'} pts</span></div>`).join('');}else{dropdown.classList.remove('active');}}
    function hideAutocomplete(){state.autocompleteVisible=false;const dropdown=document.getElementById('autocompleteDropdown');if(dropdown)dropdown.classList.remove('active');}
    function selectAutocomplete(index){const s=state.autocompleteResults[index];if(!s||!state.editingTask)return;state.editingTask.title=s.title;state.editingTask.label=s.label;state.editingTask.type=s.type||'task';state.editingTask.timeEffort=s.timeEffort;state.editingTask.mentalLoad=s.mentalLoad;state.editingTask.physicalLoad=s.physicalLoad||0;state.editingTask.impact=s.type==='event'?null:s.impact;state.editingTask.startTime=s.startTime||'';state.editingTask.endTime=s.endTime||'';state.showPhysical=s.physicalLoad>0;state.autocompleteVisible=false;state.autocompleteResults=[];renderModalOnly();}
    function updateStartTime(val){if(state.editingTask)state.editingTask.startTime=val;}
    function updateEndTime(val){if(state.editingTask)state.editingTask.endTime=val;}
    function updateRecStartTime(val){if(state.editingTemplate)state.editingTemplate.startTime=val;}
    function updateRecEndTime(val){if(state.editingTemplate)state.editingTemplate.endTime=val;}
    function openAdd(tf='today'){state.editingTask={title:'',label:'',type:'task',timeframe:tf,timeEffort:null,mentalLoad:null,physicalLoad:0,impact:null,startTime:'',endTime:''};state.showPhysical=false;state.autocompleteResults=[];state.autocompleteVisible=false;state.modalOpen='add';render();setTimeout(()=>document.getElementById('taskTitle')?.focus(),100);}
    function editTask(id){const t=state.tasks.find(x=>x.id===id);if(t){state.editingTask={...t,physicalLoad:t.physicalLoad||0,type:t.type||'task',startTime:t.startTime||'',endTime:t.endTime||''};state.showPhysical=t.physicalLoad>0;state.autocompleteResults=[];state.autocompleteVisible=false;state.modalOpen='edit';render();}}
    function closeModal(){state.modalOpen=null;state.editingTask=null;state.editingTemplate=null;state.confirmCallback=null;state.confirmMessage=null;state.showPhysical=false;state.autocompleteResults=[];state.autocompleteVisible=false;state.authSent=false;state.authLoading=false;state.authPassword='';state.showPassword=false;state.newPassword='';state.confirmNewPassword='';render();}
    function showConfirm(msg,cb){state.confirmMessage=msg;state.confirmCallback=cb;state.modalOpen='confirm';render();}
    function execConfirm(){if(state.confirmCallback)state.confirmCallback();closeModal();}
    function togglePhysicalUI(){state.showPhysical=true;renderModalOnly();}
    function confirmClearHistory(){showConfirm('Clear all completion history? This will reset your averages.',clearHistory);}
    function openAuth(){state.modalOpen='auth';state.authSent=false;state.authEmail='';state.authPassword='';state.authMode='signin';render();setTimeout(()=>document.getElementById('authEmail')?.focus(),100);}
    function setAuthMode(mode){state.authMode=mode;state.authPassword='';renderModalOnly();setTimeout(()=>document.getElementById('authEmail')?.focus(),100);}
    function submitAuth(){const email=state.authEmail.trim();if(!email||!email.includes('@')){showToast('Enter a valid email');return;}if(state.authMode==='signin'){const password=state.authPassword;if(!password){showToast('Enter your password');return;}signInWithPassword(email,password);}else{signUpWithEmail(email);}}
    function togglePasswordVisibility(){state.showPassword=!state.showPassword;renderModalOnly();}
    function openChangePassword(){state.userDropdownOpen=false;state.modalOpen='changePassword';state.newPassword='';state.confirmNewPassword='';state.showPassword=false;render();setTimeout(()=>document.getElementById('newPassword')?.focus(),100);}
    function submitChangePassword(){const newPwd=state.newPassword,confirmPwd=state.confirmNewPassword;if(!newPwd||newPwd.length<6){showToast('Password must be at least 6 characters');return;}if(newPwd!==confirmPwd){showToast('Passwords do not match');return;}changePassword(newPwd);}
    async function saveName(){const name=document.getElementById('userName')?.value.trim();const password=document.getElementById('userPassword')?.value;if(!name){showToast('Enter your name');return;}if(!password||password.length<6){showToast('Password must be at least 6 characters');return;}if(!supabaseClient||!state.user)return;try{await supabaseClient.auth.updateUser({password:password,data:{display_name:name}});localStorage.setItem('tempo_user_name',name);state.userName=name;state.modalOpen=null;render();showToast('Welcome, '+name+'!');await syncFromCloud();processMissedDays();state.lastOpenDate=getLocalDate();saveState();render();}catch(e){showToast('Could not save: '+e.message);}}
    function toggleUserDropdown(){state.userDropdownOpen=!state.userDropdownOpen;render();}
    function selType(type){state.editingTask.type=type;if(type==='event')state.editingTask.impact=null;renderModalOnly();}
    function selTimeframe(tf){state.editingTask.timeframe=tf;renderModalOnly();}
    function selLabel(l){state.editingTask.label=state.editingTask.label===l?'':l;renderModalOnly();}
    function addLabel(){const v=document.getElementById('newLabel')?.value.trim();if(v&&!state.labels.includes(v)){state.labels.push(v);if(state.editingTask)state.editingTask.label=v;saveState();}renderModalOnly();}
    function selTime(v){state.editingTask.timeEffort=v;renderModalOnly();}
    function selMental(v){state.editingTask.mentalLoad=v;renderModalOnly();}
    function selPhysical(v){state.editingTask.physicalLoad=v;renderModalOnly();}
    function selImpact(v){state.editingTask.impact=state.editingTask.impact===v?null:v;renderModalOnly();}
    function saveTask(){const title=state.editingTask.title.trim();if(!title){showToast('Enter a title');return;}state.editingTask.title=title;if(state.modalOpen==='add'){state.editingTask.id=generateId();state.editingTask.completed=false;state.editingTask.createdAt=new Date().toISOString();state.editingTask.historyEntryId=null;state.tasks.push(state.editingTask);}else{const i=state.tasks.findIndex(t=>t.id===state.editingTask.id);if(i!==-1)state.tasks[i]=state.editingTask;}saveState();closeModal();}
    function confirmDelete(){showConfirm('Delete this item?',()=>{const task=state.tasks.find(t=>t.id===state.editingTask.id);if(task&&task.historyEntryId){state.completionHistory=state.completionHistory.filter(h=>h.id!==task.historyEntryId);}state.tasks=state.tasks.filter(t=>t.id!==state.editingTask.id);saveState();showToast('Deleted');});}
    function makeRecurring(){const t=state.editingTask;if(!t)return;state.editingTemplate={title:t.title,label:t.label||'',type:t.type||'task',days:[],timeEffort:t.timeEffort,mentalLoad:t.mentalLoad,physicalLoad:t.physicalLoad||0,impact:t.impact,startTime:t.startTime||'',endTime:t.endTime||''};state.showPhysical=(t.physicalLoad||0)>0;state.modalOpen='addRecurring';render();}
    function toggleTask(id){const task=state.tasks.find(t=>t.id===id);if(!task)return;const pts=getPoints(task);if(!task.completed&&pts===null){state.editingTask={...task,physicalLoad:task.physicalLoad||0};state.showPhysical=task.physicalLoad>0;state.modalOpen='score';render();return;}if(task.completed){if(task.historyEntryId){state.completionHistory=state.completionHistory.filter(h=>h.id!==task.historyEntryId);task.historyEntryId=null;}task.completed=false;task.completedAt=null;}else{const historyId=generateId();state.completionHistory.push({id:historyId,date:getLocalDate(),points:pts,taskTitle:task.title,skipped:false});task.historyEntryId=historyId;task.completed=true;task.completedAt=new Date().toISOString();}saveState();render();}
    function completeWithScore(){if(!state.editingTask.timeEffort||!state.editingTask.mentalLoad){showToast('Select time and mental load');return;}const i=state.tasks.findIndex(t=>t.id===state.editingTask.id);if(i!==-1){const task=state.tasks[i];task.timeEffort=state.editingTask.timeEffort;task.mentalLoad=state.editingTask.mentalLoad;task.physicalLoad=state.editingTask.physicalLoad||0;task.completed=true;task.completedAt=new Date().toISOString();const historyId=generateId();state.completionHistory.push({id:historyId,date:getLocalDate(),points:getPoints(task),taskTitle:task.title,skipped:false});task.historyEntryId=historyId;}saveState();closeModal();}
    function pullToWeek(id){const task=state.tasks.find(t=>t.id===id);if(task){task.timeframe='week';saveState();render();showToast('Moved to This Week');}}
    function setFilter(l){state.activeFilter=l;render();}
    function toggleCompleted(section){state.showCompleted[section]=!state.showCompleted[section];render();}
    function openStats(){state.statsOpen=true;state.userDropdownOpen=false;render();}
    function closeStats(){state.statsOpen=false;render();}
    function openRecurring(){state.modalOpen='recurring';render();}
    function openAddRecurring(){state.editingTemplate={title:'',label:'',type:'task',days:[],timeEffort:null,mentalLoad:null,physicalLoad:0,impact:null,startTime:'',endTime:''};state.showPhysical=false;state.modalOpen='addRecurring';render();}
    function editRecurring(id){const t=state.recurringTemplates.find(x=>x.id===id);if(t){state.editingTemplate={...t,days:[...t.days],physicalLoad:t.physicalLoad||0,type:t.type||'task',startTime:t.startTime||'',endTime:t.endTime||''};state.showPhysical=t.physicalLoad>0;state.modalOpen='editRecurring';render();}}
    function confirmDeleteRecurring(id){showConfirm('Delete recurring item?',()=>{state.recurringTemplates=state.recurringTemplates.filter(t=>t.id!==id);state.tasks=state.tasks.filter(t=>t.recurringTemplateId!==id||t.completed);saveState();state.modalOpen='recurring';render();showToast('Deleted');});}
    function backToList(){state.editingTemplate=null;state.showPhysical=false;state.modalOpen='recurring';render();}
    function toggleDay(d){const i=state.editingTemplate.days.indexOf(d);if(i===-1)state.editingTemplate.days.push(d);else state.editingTemplate.days.splice(i,1);renderModalOnly();}
    function updateRecTitle(val){if(state.editingTemplate)state.editingTemplate.title=val;}
    function selRecType(type){state.editingTemplate.type=type;if(type==='event')state.editingTemplate.impact=null;renderModalOnly();}
    function selRecLabel(l){state.editingTemplate.label=state.editingTemplate.label===l?'':l;renderModalOnly();}
    function addRecLabel(){const v=document.getElementById('newRecLabel')?.value.trim();if(v&&!state.labels.includes(v)){state.labels.push(v);if(state.editingTemplate)state.editingTemplate.label=v;saveState();}renderModalOnly();}
    function selRecTime(v){state.editingTemplate.timeEffort=v;renderModalOnly();}
    function selRecMental(v){state.editingTemplate.mentalLoad=v;renderModalOnly();}
    function selRecPhysical(v){state.editingTemplate.physicalLoad=v;renderModalOnly();}
    function selRecImpact(v){state.editingTemplate.impact=state.editingTemplate.impact===v?null:v;renderModalOnly();}
    function saveRecurring(){const title=state.editingTemplate.title.trim();if(!title){showToast('Enter a title');return;}if(!state.editingTemplate.days.length){showToast('Select at least one day');return;}if(!state.editingTemplate.timeEffort||!state.editingTemplate.mentalLoad){showToast('Select time and mental load');return;}state.editingTemplate.title=title;if(state.modalOpen==='addRecurring'){state.editingTemplate.id=generateId();state.recurringTemplates.push(state.editingTemplate);}else{const i=state.recurringTemplates.findIndex(t=>t.id===state.editingTemplate.id);if(i!==-1)state.recurringTemplates[i]=state.editingTemplate;}saveState();generateRecurringFor(getLocalDate());saveState();backToList();}
    document.addEventListener('click',e=>{if(state.userDropdownOpen&&!e.target.closest('.user-menu')){state.userDropdownOpen=false;render();}});
    async function init(){loadLocal();processMissedDays();pruneHistory();state.lastOpenDate=getLocalDate();saveLocal();render();if(initSupabase()){supabaseClient.auth.onAuthStateChange(async(event,session)=>{if((event==='SIGNED_IN'||event==='INITIAL_SESSION'||event==='TOKEN_REFRESHED')&&session?.user){state.user=session.user;const localName=localStorage.getItem('tempo_user_name');const savedName=localName||session.user.user_metadata?.display_name;if(savedName){state.userName=savedName;state.syncStatus='synced';if(event==='SIGNED_IN'){closeModal();showToast('Welcome back, '+savedName.split(' ')[0]+'!');}render();await syncFromCloud();processMissedDays();state.lastOpenDate=getLocalDate();saveState();render();}else if(event==='SIGNED_IN'){state.syncStatus='synced';state.modalOpen='getName';render();}else{state.userName=session.user.email?.split('@')[0]||'User';state.syncStatus='synced';render();await syncFromCloud();processMissedDays();state.lastOpenDate=getLocalDate();saveState();render();}}else if(event==='SIGNED_OUT'){state.user=null;state.userName=null;state.syncStatus='offline';localStorage.removeItem('tempo_user_name');render();}});await checkAuth();}}
    document.getElementById('importFile').addEventListener('change',handleImport);
    init();
    setInterval(()=>{if(state.lastOpenDate!==getLocalDate()){processMissedDays();state.lastOpenDate=getLocalDate();saveState();render();}},60000);
    if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(e=>console.log('SW fail',e)));}
    </script>
</body>
</html>